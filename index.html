<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>GitHub Burndown Chart</title>
		<style>
        #container, footer, header {
            margin: .5em; 
        }
		#chart {
			border: 1px solid black;
		}
        .list {
            line-height: 125%; 
        }
        .list ul li {
            margin-top: 10px;
        }
        .list ul li img {
            float: left;
        }

        /* MEDIA QUERIES */
        @media screen and (min-width: 47.5em ) {
            .list {float: left; width: 33%;}
            #chart {margin-left: auto; margin-right: auto;}
            }
		.axis path,
		.axis line {
		  	fill: none;
		  	stroke: #ddd;
		  	shape-rendering: crispEdges;
		}
		.line {
			fill: none;
		  	stroke-width: 1.5px;
		}
		.line.ideal {
		  	stroke: steelblue;
		}
		.line.actual {
			stroke: red;
			stroke-width: 5px;
		}
        img.avatar {
            width: 30px;
            margin-right: 1em;
        }
        .label {
            margin: 0 0.5em;
        }
		</style>
        <script type="text/javascript" charset="utf-8" src="http://code.jquery.com/jquery-latest.js"></script>
   	<script src="http://d3js.org/d3.v3.min.js"></script>        
        <script type="text/javascript">
            var owner = 'ualbertalib';
            var repo = 'hydranorth';
            var milestone = '20';

            var hash = window.location.hash;
            if (hash != "") {
                // should be #ualbertalib/hydranorth/20
                parts = hash.substring(1).split("/");
                owner = parts[0];
                repo = parts[1];
                milestone = parts[2];
            }

            var holidays = ['2015-07-01','2015-08-03','2015-09-07','2015-10-12',
                '2015-11-11','2015-12-25','2015-12-28','2015-12-29','2015-12-30',
                '2015-12-31'];

            var issuedata = {
                "closed": {"issues": 0, "points": 0},
                "wip": {"issues": 0, "points": 0},
                "ready": {"issues": 0, "points": 0}
            }
			$.fn.sort = function(){
				return this.pushStack([].sort.apply(this, arguments), []);
			};

            //

			function sortByClosedAt(a, b){
                var date1 = !a.closed_at ? '1970-01-01T00:00:00Z' : a.closed_at;
                var date2 = !b.closed_at ? '1970-01-01T00:00:00Z' : b.closed_at;

                return date1 > date2 ? 1 : -1;
			}

            function showIssue(issue) {
                // build li element containing issue description
                // attach to appropriate ul in issues div
                var status;
                if (issue.closed_at)
                    status="closed"
                else if (issue.assignee)
                    status="wip"
                else status="ready";

                var li = $("<li>");
                if (issue.assignee) {
                    li.append("<img class='avatar' " +
                        "src='" + issue.assignee.avatar_url + "'" +
                        "title='" + issue.assignee.login + "'" + 
                        "></img>")
                }
                var a = $("<a href='" + issue.html_url + "'>");
                a.append(issue.number);
                li.append(a);
                li.append(": " + issue.title);

                for (var i = 0; i < issue.labels.length; i++) {
                    li.append("<span class='label' style='background: #" + 
                        issue.labels[i].color + "'>" +
                        issue.labels[i].name) + "</span>";
                }

                $("#" + status).append(li);

                issuedata[status].issues += 1;
                issuedata[status].points += issue.burndown_points;

            }
            //

            var perPage = 30,
                totalPages = 0,
                totalIssues = 0,
                totalPoints = 0,
                closedPoints = 0,
                numberOfClosedIssues = 0,
                numberOfOpenIssues = 0,
                actual = [], jsonData = [], issueData = [],
                ideal;

            $(document).ready(function(){

                $.getJSON('https://api.github.com/repos/' + owner + '/' + repo + 
                    '/issues?' + 
                    '&state=all&sort=created&direction=asc&milestone=' + milestone, 
                    	function(data){

                    jsonData = data.sort(sortByClosedAt);
                    //alert(JSON.stringify(jsonData));
                    $.each(jsonData, function(i, item){
                        if(!jsonData[i].closed_at)
                            numberOfOpenIssues++;
                        else
                            numberOfClosedIssues++;
                    });

                    totalIssues = numberOfClosedIssues + numberOfOpenIssues;
                    //

                    numberOfClosedIssues = 0; //reset in order to increment through

                    milestonedata = null;

                    $.each(jsonData, function(i, item){
                        if (milestonedata == null) {
                            milestonedata = jsonData[i].milestone;
                            //alert(JSON.stringify(milestonedata));
                        }
                        var points;
                        var labelnames = [];
                        $.each (jsonData[i].labels, function(i, label){
                            labelnames.push(label.name);
                        });
                        if (labelnames.indexOf('size:xlarge') > -1) points = 64;
                        else if (labelnames.indexOf('size:large') > -1) points = 16;
                        else if (labelnames.indexOf('size:medium') > -1) points = 4;
                        else if (labelnames.indexOf('size:small') > -1) points = 2;
                        else if (labelnames.indexOf('size:xsmall') > -1) points = 1;
                        else points = 4;
                        jsonData[i].burndown_points = points;
                        totalPoints += points;
                        if(jsonData[i].closed_at){
                            closedPoints += points;
                            numberOfClosedIssues++;
                            actual.push({date: new Date(jsonData[i].closed_at), points: closedPoints});
                            issueData.push('#' + jsonData[i].number + ': ' + jsonData[i].title);
                        }
                        showIssue(jsonData[i]);
                    });

                    // update headings
                    $("#h1").html(owner + '/' + repo + ": " + milestonedata.title);

                    function showIssuedata(status) {
                        var data = issuedata[status];
                        $("#" + status + "data").html("(" + data.issues + " issues, " 
                            + data.points + " points)");
                    }
                    for (key in issuedata) {
                        showIssuedata(key);
                    }

                	// prepare data for d3
        			/*
        			var ideal = [
						{date: new Date(2013, 1, 26), points: 50},
						// Fill in the rest of the points!
						{date: new Date(2013, 2, 8), points: 0}
					];
					*/
                    end = new Date(milestonedata.due_on);
					end.setDate(end.getDate() + 1);
                    start = new Date(milestonedata.due_on);
					start.setDate(start.getDate() - 11);

                    // add starting point to actual line
                    actual.splice(0, 0, {date: start, points: 0});

					// extend actual to now
					today = new Date(new Date().toISOString());
					lastpoints = actual[actual.length - 1].points;
                    actual.push({date: today, points: lastpoints});

                    // fill in values on ideal line, reflecting weekends when the line
                    // does not go down.

                    var cur = new Date(),
                        curPoints = totalPoints,
                        workdays = 0,
                        pointsPerDay = 0,
                        ideal = [];

                    // count workdays
                    cur.setTime(start.getTime());
                    while(cur <= end) {
                        weekday = cur.getDay();
                        datestring = cur.toISOString().substring(0, 10); // get yyyy-mm-dd
                        // workdays: not Sun, not Sat, not on holidays list
                        if (weekday > 0 && weekday < 6 && holidays.indexOf(datestring) == -1)
                            workdays++;
                        cur.setDate(cur.getDate() + 1);
                    }

                    pointsPerDay = totalPoints / workdays,

                    // assign points to days for ideal line
                    cur.setTime(start.getTime());
                    while(cur <= end) {
                        ideal.push({date:new Date(cur.getTime()), points: curPoints});
                        weekday = cur.getDay();
                        datestring = cur.toISOString().substring(0, 10); // get yyyy-mm-dd
                        if (weekday > 0 && weekday < 6 && holidays.indexOf(datestring) == -1)
                            curPoints -= pointsPerDay;
                        cur.setDate(cur.getDate() + 1);
                    }

                    // lay out chart

        			var margin = {top: 20, right: 20, bottom: 30, left: 50},
        	   			width = 960 - margin.left - margin.right,
        	    		height = 500 - margin.top - margin.bottom;
        			var x = d3.time.scale()
        				.range([0, width]);
        			var y = d3.scale.linear()
        	    		.range([height, 0]);
        	 

        			var idealLine = d3.svg.line()
        				.x(function(d) { return x(d.date); })
        	    		.y(function(d) { return y(d.points); });
        	    	var actualLine = d3.svg.line()
        	    		.x(function(d) { return x(d.date); })
        	    		.y(function(d) { return y(totalPoints - d.points); });
        	 
        			x.domain(d3.extent(ideal, function(d){return d.date;}));
        			y.domain([0, totalPoints]);

                    function make_x_axis() {
                        return d3.svg.axis()
            				.scale(x)
            				.orient("bottom")
                            .tickFormat(d3.time.format("%a %e"))
                            }

        			function make_y_axis() {
                        return d3.svg.axis()
            			    .scale(y)
            			    .orient("left");
            		}

        			var chart = d3.select("#chart").append("svg")
        				.attr("class", "chart")
        				.attr("width", width + margin.left + margin.right)
        	    		.attr("height", height + margin.top + margin.bottom)
        			.append("g")
        	    		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // center the day labels under their column
                    // based on http://stackoverflow.com/questions/17544546/d3-js-align-text-labels-between-ticks-on-the-axis/17544785#answer-17630938
                    function adjustTextLabels(selection) {
                        // remove last label (for the day after the end of the milestone)
                        labels = selection.selectAll('.chart text');
                        labels[0][labels[0].length - 1].remove();
                        // transform remaining labels: move right 1/2 width of day column
                        selection.selectAll('.chart text')
                            .attr('transform', 'translate(' + daysToPixels(1) / 2 + ',0)');
                    }

                    // calculate the width of the days in the timeScale
                    function daysToPixels(days, timeScale) {
                        var d1 = new Date();
                        return x(d3.time.day.offset(d1, days)) - x(d1);
                    }

                    chart.append("g")         
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(make_x_axis()
                            .tickSize(-height, 0, 0)
                        )
                        .call(adjustTextLabels);     // adjusts text labels on the axis 

                    chart.append("g")
                        .attr("class", "y axis")
                        .call(make_y_axis()
                            .tickSize(-width, 0, 0)
                        )
                        .append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", -40)
                            .attr("dy", ".71em")
                            .style("text-anchor", "end")
                            .text("Points");


		    // Paint the ideal line
        		    chart.append("path")
        		    	.datum(ideal)
        		      	.attr("class", "line ideal")
        		      	.attr("d", idealLine);

        		    // Paint the actual line
        		    chart.append("path")
        		    	.datum(actual)
        		      	.attr("class", "line actual")
        		      	.attr("d", actualLine);
        			    
    			})

            });
        </script>
    </head>
    <body>
        <h1 id="h1">Fetching...</h1>
        <div id="container">
            <div id="chart"></div>
            <div id="issues">
                <div class="list">
                    <h2>Closed <span id="closeddata"></span></h2>
                    <ul id="closed" class="issues"></ul>
                </div>
                <div class="list">
                    <h2>WIP <span id="wipdata"></span></h2>
                    <ul id="wip" class="issues"></ul>
                </div>
                <div class="list">
                    <h2>Ready <span id="readydata"></span></h2>
                    <ul id="ready" class="issues"></ul>
                </div>
            </div>
        </div>
    </body>
</html>
